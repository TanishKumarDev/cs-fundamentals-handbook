# **Day 21 - SQL Views, Indexes, Cursors, Triggers**

## SQL Triggers

### **1. What is a Trigger?**

A **trigger** is a **special stored procedure** in a database that is **automatically invoked** when specific events occur, such as `INSERT`, `UPDATE`, or `DELETE`.

**Purpose:**

* Automates repetitive tasks
* Maintains **data integrity**
* Enforces business rules
* Records audit trails or changes

**Syntax (Generic):**

```sql
CREATE TRIGGER trigger_name
[BEFORE | AFTER] 
{INSERT | UPDATE | DELETE}
ON table_name
FOR EACH ROW
BEGIN
   -- SQL statements to execute
END;
```

---

### **2. Types of Triggers**

#### **2.1 DDL Triggers**

* Activated by **Data Definition Language (DDL)** events: `CREATE_TABLE`, `ALTER_TABLE`, `DROP_TABLE`, etc.
* Useful to **track or prevent structural changes**.

**Example: Prevent Table Changes**

```sql
CREATE TRIGGER prevent_table_creation
ON DATABASE
FOR CREATE_TABLE, ALTER_TABLE, DROP_TABLE
AS
BEGIN
   PRINT 'You cannot create, drop or alter tables in this database';
   ROLLBACK;
END;
```

---

#### **2.2 DML Triggers**

* Fired by **Data Manipulation Language (DML)** events: `INSERT`, `UPDATE`, `DELETE`.
* Used for **data validation, cascading updates, or logging changes**.

**Example: Prevent Unauthorized Updates**

```sql
CREATE TRIGGER prevent_update
ON students
FOR INSERT, UPDATE, DELETE
AS
BEGIN
    RAISERROR('You cannot insert, update, or delete rows in this table.', 16, 1);
END;
```

---

#### **2.3 Logon Triggers**

* Fired on **user logon events**
* Used for **monitoring logins, restricting access, or limiting sessions**.

**Example: Track Logins**

```sql
CREATE TRIGGER track_logon
ON LOGON
AS
BEGIN
   PRINT 'A new user has logged in.';
END;
```

---

### **3. BEFORE vs AFTER Triggers**

| Trigger Type | When it Runs             | Use Case                                          |
| ------------ | ------------------------ | ------------------------------------------------- |
| BEFORE       | Before the DML operation | Validate or modify values before insertion/update |
| AFTER        | After the DML operation  | Logging, cascading updates, post-processing       |

**Example: BEFORE Trigger for Calculations**

```sql
CREATE TRIGGER calculate_total
BEFORE INSERT ON Student_Marks
FOR EACH ROW
BEGIN
   SET NEW.total = NEW.sub1 + NEW.sub2 + NEW.sub3;
   SET NEW.percentage = NEW.total / 3;
END;
```

---

### **4. Real-World Examples**

#### **4.1 Automatically Updating Related Tables**

```sql
CREATE TRIGGER update_student_score
AFTER UPDATE ON student_grades
FOR EACH ROW
BEGIN
   UPDATE total_scores
   SET score = score + :new.grade
   WHERE student_id = :new.student_id;
END;
```

#### **4.2 Data Validation**

```sql
CREATE TRIGGER validate_grade
BEFORE INSERT ON student_grades
FOR EACH ROW
BEGIN
   IF :new.grade < 0 OR :new.grade > 100 THEN
      RAISE_APPLICATION_ERROR(-20001, 'Invalid grade value.');
   END IF;
END;
```

---

### **5. Viewing and Managing Triggers**

* Query triggers in SQL Server:

```sql
SELECT name, is_instead_of_trigger
FROM sys.triggers
WHERE type = 'TR';
```

* Using **SQL Server Management Studio (SSMS)**:

  1. Expand **Databases** → select database
  2. Expand **Tables** → select table
  3. Click **Triggers** to view all triggers

---

### **6. Advantages of Triggers**

* Automation of repetitive tasks
* Enforces **data integrity**
* Conditional operations on row-level events
* Useful for complex relationships

### **7. Limitations**

* Can affect performance (executed automatically on DML/DDL)
* Adds **complexity** to database operations
* Harder to debug for beginners
* Overuse may cause unintended side-effects
