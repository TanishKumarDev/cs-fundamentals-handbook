# **SQL Subquery**

A **subquery** is a **query nested inside another SQL query**. It allows you to perform operations that depend on the result of another query.

**Why use subqueries?**

* To **filter rows** based on results from another table/query.
* To **aggregate data** dynamically, e.g., average, max, sum.
* To **update or delete** data conditionally.
* To **simplify complex queries** instead of writing multiple separate queries.

**Subqueries are often used in:** `SELECT`, `INSERT`, `UPDATE`, `DELETE` statements.

---

## **1. Syntax**

```sql
SELECT column_name
FROM table_name
WHERE column_name operator 
   (SELECT column_name 
    FROM table_name 
    WHERE ... );
```

**Clauses where subqueries can appear:**

* `WHERE`: filter rows based on subquery results.
* `FROM`: treat the subquery as a temporary (derived) table.
* `HAVING`: filter grouped results after aggregation.

---

## **2. Types of Subqueries**

### **2a. Single-Row Subquery**

* Returns **exactly one row**.
* Used with comparison operators: `=`, `>`, `<`.

**Example:** Find employee with the **highest salary**

```sql
SELECT * 
FROM Employees
WHERE Salary = (SELECT MAX(Salary) FROM Employees);
```

**Logic:**

* Inner query finds the **maximum salary**.
* Outer query selects the employee(s) with that salary.

---

### **2b. Multi-Row Subquery**

* Returns **multiple rows**.
* Use operators like `IN`, `ANY`, `ALL`.

**Example:** Employees in **New York departments**

```sql
SELECT * 
FROM Employees
WHERE DepartmentID IN (
    SELECT DepartmentID 
    FROM Departments 
    WHERE Location = 'New York'
);
```

**Logic:**

* Inner query returns all department IDs in New York.
* Outer query selects employees in those departments.

---

### **2c. Correlated Subquery**

* **Depends on the outer query**.
* Evaluated **once per row** of the outer query.
* Can be slower on large datasets.

**Example:** Employees earning **more than their departmentâ€™s average salary**

```sql
SELECT e.Name, e.Salary
FROM Employees e
WHERE e.Salary > (
    SELECT AVG(Salary) 
    FROM Employees 
    WHERE DepartmentID = e.DepartmentID
);
```

**Logic:**

* Inner query calculates the **average salary for the employee's department**.
* Outer query checks if the employee earns more than that average.

---

## **3. Examples Using Subqueries**

### **3a. Subquery in WHERE Clause**

Fetch students in **section A**

```sql
SELECT NAME, LOCATION, PHONE_NUMBER 
FROM Student 
WHERE ROLL_NO IN (
    SELECT ROLL_NO 
    FROM New_Student 
    WHERE SECTION = 'A'
);
```

**Logic:**

* Inner query selects roll numbers from `New_Student`.
* Outer query fetches details from `Student` matching those roll numbers.

---

### **3b. Subquery with INSERT**

Copy data from a temporary table

```sql
INSERT INTO Student 
SELECT * FROM Temp_Students;
```

**Logic:**

* Subquery selects all rows from `Temp_Students`.
* Outer query inserts them into `Student`.

---

### **3c. Subquery with DELETE**

Delete rows based on conditions

```sql
DELETE FROM Student
WHERE ROLL_NO IN (
    SELECT ROLL_NO 
    FROM Student 
    WHERE ROLL_NO <= 101 OR ROLL_NO = 201
);
```

**Logic:**

* Subquery selects specific roll numbers.
* Outer query deletes students matching those roll numbers.

---

### **3d. Subquery with UPDATE**

Update rows conditionally

```sql
UPDATE Student
SET NAME = 'Geeks'
WHERE LOCATION IN (
    SELECT LOCATION 
    FROM Student 
    WHERE LOCATION IN ('Salem', 'Delhi')
);
```

**Logic:**

* Subquery selects locations 'Salem' and 'Delhi'.
* Outer query updates the name for students in those locations.

---

### **3e. Subquery in FROM Clause**

Use subquery as a **temporary table**

```sql
SELECT NAME, PHONE_NUMBER
FROM (
    SELECT NAME, PHONE_NUMBER, LOCATION 
    FROM Student 
    WHERE LOCATION LIKE 'C%'
) AS subquery_table;
```

**Logic:**

* Inner query selects students with location starting with "C".
* Outer query fetches only `NAME` and `PHONE_NUMBER`.

---

### **3f. Subquery with JOIN**

Combine subquery with a join

```sql
SELECT s.NAME, s.LOCATION, ns.SECTION
FROM Student s
INNER JOIN (
    SELECT ROLL_NO, SECTION 
    FROM New_Student 
    WHERE SECTION = 'A'
) ns
ON s.ROLL_NO = ns.ROLL_NO;
```

**Logic:**

* Subquery selects roll numbers in section A.
* Outer query joins it with `Student` to get name, location, and section.

---

## **4. Summary Notes**

* **Subquery**: Query inside another query.
* Can appear in `SELECT`, `FROM`, `WHERE`, `HAVING`.
* **Single-row**, **multi-row**, and **correlated** are the main types.
* Useful for **filtering, aggregation, updating, deleting** dynamically.
* Simplifies **complex database tasks**.
